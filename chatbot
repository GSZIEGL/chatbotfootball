import os
import streamlit as st
from groq import Groq
from pypdf import PdfReader
from docx import Document

# ------------------------------------------------
# 1. Groq kliens inicializ√°l√°sa
# ------------------------------------------------

def get_groq_client():
    """
    API kulcs:
    - helyi futtat√°sn√°l: export GROQ_API_KEY="gsk-...."
    - vagy add meg a Streamlit oldals√°vban
    """
    api_key_env = os.getenv("GROQ_API_KEY")
    api_key_input = st.sidebar.text_input(
        "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",
        type="password",
        help="Biztons√°gosabb, ha k√∂rnyezeti v√°ltoz√≥ban √°ll√≠tod be: GROQ_API_KEY."
    )
    api_key = api_key_input or api_key_env

    if not api_key:
        st.error("Adj meg Groq API kulcsot (oldals√°v), vagy √°ll√≠tsd be a GROQ_API_KEY k√∂rnyezeti v√°ltoz√≥t.")
        st.stop()

    return Groq(api_key=api_key)


GROQ_MODEL = "llama-3.3-70b-versatile"


# ------------------------------------------------
# 2. PDF / DOCX feldolgoz√≥ f√ºggv√©nyek
# ------------------------------------------------

def extract_text_from_pdf(file):
    reader = PdfReader(file)
    text = ""
    for page in reader.pages:
        t = page.extract_text()
        if t:
            text += t + "\n"
    return text


def extract_text_from_docx(file):
    doc = Document(file)
    return "\n".join([p.text for p in doc.paragraphs])


def build_document_text(uploaded_files):
    full_text = ""
    for f in uploaded_files:
        if f.name.lower().endswith(".pdf"):
            txt = extract_text_from_pdf(f)
        elif f.name.lower().endswith(".docx"):
            txt = extract_text_from_docx(f)
        else:
            st.warning(f"Nem t√°mogatott form√°tum: {f.name}")
            continue

        full_text += "\n" + txt

    return full_text.strip()


# ------------------------------------------------
# 3. LLM-h√≠v√≥ f√ºggv√©nyek (√∂sszefoglal√≥ / Q&A / teszt)
# ------------------------------------------------

def llm_chat(client: Groq, prompt: str, temperature: float = 0.4) -> str:
    resp = client.chat.completions.create(
        model=GROQ_MODEL,
        messages=[{"role": "user", "content": prompt}],
        temperature=temperature,
    )
    return resp.choices[0].message.content


def summarize_docs(client: Groq, doc_text: str, word_limit: int) -> str:
    if not doc_text.strip():
        return "Nincs bet√∂lt√∂tt sz√∂veg."

    prompt = f"""
Az al√°bbi sz√∂veg edz≈ëi / szakmai anyag (pl. klubfiloz√≥fia, edz√©selvek).

Feladatod:
- Foglald √∂ssze maximum {word_limit} sz√≥ban.
- Legyen vil√°gos, gyakorlatias, edz≈ëknek sz√≥l√≥ nyelven.

SZ√ñVEG:
{doc_text}
"""
    return llm_chat(client, prompt, temperature=0.3)


def ask_question(client: Groq, doc_text: str, question: str) -> str:
    if not doc_text.strip():
        return "Nincs bet√∂lt√∂tt sz√∂veg."

    prompt = f"""
Az al√°bbi sz√∂veg egy vagy t√∂bb dokumentum tartalma (pl. futballfiloz√≥fia, edz√©selvek, klubdokumentum).

SZ√ñVEG:
{doc_text}

K√âRD√âS:
{question}

V√ÅLASZ:
- Csak a sz√∂veg alapj√°n v√°laszolj.
- Ha a v√°lasz NINCS benne a sz√∂vegben, mondd ezt: "Nincs el√©g inform√°ci√≥ a sz√∂vegben."
- L√©gy t√∂m√∂r, vil√°gos, edz≈ëknek sz√≥l√≥ st√≠lusban.
"""
    return llm_chat(client, prompt, temperature=0.3)


def generate_test(client: Groq, doc_text: str, test_type: str, num_questions: int) -> str:
    if not doc_text.strip():
        return "Nincs bet√∂lt√∂tt sz√∂veg."

    if test_type == "Feleletv√°laszt√≥s":
        style = """
Feleletv√°laszt√≥s tesztet k√©sz√≠ts.
Minden k√©rd√©shez legyen 4 v√°laszlehet≈ës√©g (A‚ÄìD), √©s pontosan egy helyes.
"""
    else:
        style = """
Kieg√©sz√≠tend≈ë k√©rd√©seket k√©sz√≠ts.
Minden k√©rd√©sben hi√°nyozzon egy kulcskifejez√©s (_____ jel√∂li a hi√°nyt).
"""

    prompt = f"""
Az al√°bbi sz√∂veg alapj√°n √°ll√≠ts √∂ssze {num_questions} k√©rd√©ses tesztet edz≈ëk sz√°m√°ra.

{style}

A k√©rd√©sek m√©rj√©k a sz√∂veg meg√©rt√©s√©t, ne legyenek trivi√°lisak.

SZ√ñVEG:
{doc_text}

Add vissza magyarul, struktur√°ltan:

1. k√©rd√©s
A)
B)
C)
D)

...

A v√©g√©n k√ºl√∂n blokkban:
MEGOLD√ìKULCS:
1. ...
2. ...
stb.
"""
    return llm_chat(client, prompt, temperature=0.5)


# ------------------------------------------------
# 4. Streamlit UI
# ------------------------------------------------

def main():
    st.set_page_config(page_title="Edz≈ëi doksi-chatbot & tesztgener√°tor", layout="wide")
    st.title("‚öΩ Edz≈ëi doksi-chatbot & tesztgener√°tor (Groq + Streamlit)")

    client = get_groq_client()

    # Session state: dokumentum sz√∂vege
    if "doc_text" not in st.session_state:
        st.session_state["doc_text"] = ""

    st.markdown("### 1Ô∏è‚É£ Doksik felt√∂lt√©se")

    uploaded_files = st.file_uploader(
        "PDF vagy DOCX f√°jlok felt√∂lt√©se",
        type=["pdf", "docx"],
        accept_multiple_files=True
    )

    if st.button("üìÑ Doksik feldolgoz√°sa"):
        if not uploaded_files:
            st.warning("El≈ëbb t√∂lts fel legal√°bb egy f√°jlt.")
        else:
            with st.spinner("Dokumentumok beolvas√°sa..."):
                doc_text = build_document_text(uploaded_files)
                st.session_state["doc_text"] = doc_text
            st.success(f"K√©sz! Bet√∂lt√∂tt sz√∂veg hossza: {len(doc_text)} karakter.")

    if st.session_state["doc_text"]:
        st.info(f"Bet√∂lt√∂tt sz√∂veg hossza: {len(st.session_state['doc_text'])} karakter.")
    else:
        st.warning("M√©g nincs bet√∂lt√∂tt sz√∂veg. T√∂lts fel doksit √©s kattints a 'Doksik feldolgoz√°sa' gombra.")

    st.markdown("---")
    st.markdown("### 2Ô∏è‚É£ Funkci√≥k")

    col1, col2, col3 = st.columns(3)

    # -------- √ñSSZEFOGLAL√ì --------
    with col1:
        st.subheader("üìù √ñsszefoglal√≥")
        word_limit = st.selectbox(
            "√ñsszefoglal√≥ hossza (sz√≥ban):",
            [50, 100, 150, 200],
            index=1
        )
        if st.button("√ñsszefoglal√≥ gener√°l√°sa"):
            if not st.session_state["doc_text"]:
                st.warning("El≈ëbb t√∂lts fel √©s dolgozz fel egy dokumentumot.")
            else:
                with st.spinner("√ñsszefoglal√≥ k√©sz√≠t√©se..."):
                    summary = summarize_docs(client, st.session_state["doc_text"], word_limit)
                st.markdown("#### √ñsszefoglal√≥:")
                st.write(summary)

    # -------- K√âRD√âS-V√ÅLASZ --------
    with col2:
        st.subheader("‚ùì K√©rd√©s a doksir√≥l")
        question = st.text_area("√çrd be a k√©rd√©sed:", height=150)
        if st.button("V√°lasz k√©r√©se"):
            if not st.session_state["doc_text"]:
                st.warning("El≈ëbb t√∂lts fel √©s dolgozz fel egy dokumentumot.")
            elif not question.strip():
                st.warning("√çrj be egy k√©rd√©st.")
            else:
                with st.spinner("V√°lasz gener√°l√°sa..."):
                    answer = ask_question(client, st.session_state["doc_text"], question)
                st.markdown("#### V√°lasz:")
                st.write(answer)

    # -------- TESZT GENER√ÅL√ÅS --------
    with col3:
        st.subheader("üß™ Teszt gener√°l√°sa")
        test_type = st.radio(
            "Teszt t√≠pusa:",
            ["Feleletv√°laszt√≥s", "Kieg√©sz√≠tend≈ë"]
        )
        num_questions = st.slider("K√©rd√©sek sz√°ma:", min_value=3, max_value=20, value=5, step=1)

        if st.button("Teszt gener√°l√°sa"):
            if not st.session_state["doc_text"]:
                st.warning("El≈ëbb t√∂lts fel √©s dolgozz fel egy dokumentumot.")
            else:
                with st.spinner("Teszt gener√°l√°sa..."):
                    test_text = generate_test(client, st.session_state["doc_text"], test_type, num_questions)
                st.markdown("#### Gener√°lt teszt:")
                st.text_area("Teszt (m√°solhat√≥):", value=test_text, height=350)


if __name__ == "__main__":
    main()
